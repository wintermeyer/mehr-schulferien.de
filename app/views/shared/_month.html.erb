<% if resource.class == FederalState %>
  <% federal_state = resource %>
  <% city = nil %>
  <% school = nil %>
<% end %>
<% if resource.class == City %>
  <% federal_state = resource.federal_state %>
  <% city = resource %>
  <% school = nil %>
<% end %>
<% if resource.class == School %>
  <% federal_state = resource.city.federal_state %>
  <% city = resource.city %>
  <% school = resource %>
<% end %>

<% days = month.days.order(:value).reverse_order %>
<% if days.last.wday == 0 %>
<% elsif days.last.wday > 1 %>
  <% (days.last.wday - 1).times{days.push(nil)} %>
<% end %>
<% days = days.reverse %>
<% 6.times{days.push(nil)} %>

<% cache ['month calendar headline', month] do %>
  <div class="row">
    <div class="col-xs-8">
      <h3><%= I18n.t("date.month_names")[month.value] %></h3>
    </div>
    <div class="col-xs-4">
      <h3 class="text-muted"><%= month.year %></h3>
    </div>
  </div>
<% end %>

<table class="table table-condensed">
  <% cache ['month calendar weekdays row', month] do %>
    <thead>
      <tr>
        <% [1,2,3,4,5,6,0].each do |weekday| %>
          <% if WEEKEND_WDAYS.include?(weekday) %>
            <th class="active"><%= I18n.t("date.abbr_day_names")[weekday] %>.</th>    
          <% else %>
            <th><%= I18n.t("date.abbr_day_names")[weekday] %>.</th>    
          <% end %>
        <% end %>
      </tr>
    </thead>
  <% end %>
  <% bewegliche_ferientage_ids = [] %>
  <tbody>
    <% holiday_vacation_periods = [] %>
    <% days.each_slice(7).to_a.each do |week| %>
      <% if week.uniq != [nil] %>
        <tr>
          <% week.each do |day| %>
            <% if day.nil? %>
              <% css_class = nil %>
            <% else %>
              <% if day.slots.where(slotable: federal_state).any? %>
                <% css_class = 'success' %>
              <% elsif day.is_beweglicher_ferientag?(resource) %>
                <% css_class = 'warning' %>
                <% bewegliche_ferientage_ids << day.id %>
              <% else %>
                <% css_class = nil %>
              <% end %>
              <% if WEEKEND_WDAYS.include?(day.wday) || day.slots.where(vacation_type_id: VacationType.where(public_holiday: true)).where(slotable: federal_state).any? %>
                <% css_class = 'active' %>
              <% end %>
            <% end %>

            <% if css_class %>
              <td class="text-right <%= css_class %>"><%= day %></td>
            <% else %>
              <td class="text-right"><%= day %></td>
            <% end %>
          <% end %>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<%= render partial: "federal_states/vacation_periods", locals: {federal_state: federal_state, days: month.days} %>

<%= render partial: "federal_states/long_weekend_public_holiday_vacation_periods", locals: {federal_state: federal_state, month: month} %>

<% if @city && @could_be_vacation_periods %>
  <% if @could_be_vacation_periods.where(start_date: (month.days.order(:value).first.value .. month.days.order(:value).last.value)).any? %>
    <dl>
      <% @could_be_vacation_periods.where(start_date: (month.days.order(:value).first.value .. month.days.order(:value).last.value)).pluck(:start_date).uniq.each do |start_date| %>
        <dt>Beweglicher Ferientag:<sup>*</sup></dt>
        <dd>
          <%= l start_date, format: :default %>

          <span class="badge">
            TBA
          </span>
        </dd>
      <% end %>
    </dl>
    <p class="warning"><small><sup>*</sup> Bewegliche Ferientage gelten nicht für alle Schulen. Bitte überprüfen Sie den Kalender Ihrer Schule.</small></p>
  <% end %>
<% end %>

<%= render partial: "federal_states/public_holiday_vacation_periods", locals: {federal_state: federal_state, month: month} %>
